name: Build, test and publish

permissions:
  contents: read
  packages: write
  security-events: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 3" # Build the preview image every Wednesday at 03:00
  release:
    types:
      - published
  push:
    branches:
      - main
      - feature/**
    paths:
      - .github/**
      - docker/**

concurrency:
  group: ${{ github.ref }}-publish
  cancel-in-progress: true

jobs:
  # python:
  #   name: Python
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: Build
  #       id: build
  #       uses: ./.github/actions/build
  #       with:
  #         image-name: tna-python
  #         docker-context: docker/tna-python
  #         ignore-linting-rules: DL3002,DL3006
  #         github-token: ${{ secrets.GITHUB_TOKEN }}
  #     - name: Test
  #       uses: ./.github/actions/test
  #       with:
  #         application-repository: nationalarchives/flask-application-template
  #         service: app
  #         image: ghcr.io/${{ github.repository_owner }}/tna-python
  #         image: tna-python
  #         image-tag: ${{ steps.build.outputs.tag }}

  # python-root:
  #   name: Python (root)
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: Build
  #       id: build
  #       uses: ./.github/actions/build
  #       with:
  #         image-name: tna-python-root
  #         docker-context: docker/tna-python
  #         user-image: root
  #         ignore-linting-rules: DL3002,DL3006
  #         github-token: ${{ secrets.GITHUB_TOKEN }}

  python-django:
    name: Python Django
    # needs: python
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build
        id: build
        uses: ./.github/actions/build
        with:
          image-name: tna-python-django
          base-image: ghcr.io/nationalarchives/tna-python
          docker-context: docker/tna-python-django
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Test
        uses: ./.github/actions/test
        with:
          application-repository: nationalarchives/django-application-template
          service: app
          # image: ghcr.io/${{ github.repository_owner }}/tna-python-django
          image: tna-python-django
          image-tag: ${{ steps.build.outputs.tag }}
      - name: Push
        uses: ./.github/actions/push
        with:
          image-name: tna-python-django
          base-image: ghcr.io/nationalarchives/tna-python
          docker-context: docker/tna-python-django
          github-token: ${{ secrets.GITHUB_TOKEN }}

  # python-django-root:
  #   name: Python Django (root)
  #   needs: python-root
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: Build
  #       id: build
  #       uses: ./.github/actions/build
  #       with:
  #         image-name: tna-python-django-root
  #         base-image: ghcr.io/nationalarchives/tna-python-root
  #         docker-context: docker/tna-python-django
  #         ignore-linting-rules: DL3002
  #         github-token: ${{ secrets.GITHUB_TOKEN }}

  # python-dev:
  #   name: Python Dev
  #   needs: python-root
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: Build
  #       id: build
  #       uses: ./.github/actions/build
  #       with:
  #         image-name: tna-python-dev
  #         base-image: ghcr.io/nationalarchives/tna-python-root
  #         docker-context: docker/tna-python-dev
  #         ignore-linting-rules: DL3002,DL3008
  #         github-token: ${{ secrets.GITHUB_TOKEN }}
