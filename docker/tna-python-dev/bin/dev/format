#!/bin/bash

set -e

cd /app || return

[[ -z $FIX ]] && FIX=true

if [ "$FIX" = true ]
then
  echo "Fixing issues..."
else
  echo "Reporting issues without fixing..."
fi

echo "Running isort..."
if [ -f "/app/.isort.cfg" ]
then
  echo "Using app config"
  ISORT_CONFIG="/app/.isort.cfg"
else
  echo "Using default config"
  ISORT_CONFIG="/home/app/.isort.cfg"
fi
if [ "$FIX" = true ]
then
  isort --settings-file "$ISORT_CONFIG" /app --overwrite-in-place
else
  isort --settings-file "$ISORT_CONFIG" /app --diff
fi
echo

echo "Running black..."
if [ "$FIX" = true ]
then
  black -t py39 -t py310 -t py311 -t py312 -t py313 /app
else
  black -t py39 -t py310 -t py311 -t py312 -t py313 --check /app
fi
echo

echo "Running flake8..."
if [ -f "/app/.flake8" ]
then
  echo "Using app config"
  FLAKE8_CONFIG="/app/.flake8"
else
  echo "Using default config"
  FLAKE8_CONFIG="/home/app/.flake8"
fi
flake8 --config="$FLAKE8_CONFIG" /app
echo

DISABLE_DJLINT=$(echo "$DISABLE_DJLINT" | tr '[:upper:]' '[:lower:]')
if [ "$DISABLE_DJLINT" != "true" ]
then
  if [ -d "/app/app/templates" ]
  then
    echo "Running djLint (for Jinja2)..."
    if [ -f "/app/.djlintrc" ]
    then
      echo "Using app config"
      DJLINT_CONFIG="/app/.djlintrc"
    else
      echo "Using default config"
      DJLINT_CONFIG="/home/app/.djlintrc"
    fi
    djlint /app/app/templates --configuration "$DJLINT_CONFIG" --lint
    if [ "$FIX" = true ]
    then
      # djlint /app/app/templates --configuration "$DJLINT_CONFIG" --reformat --quiet || true
      # djhtml /app/app/templates --tabwidth 2
      echo
    else
      # djhtml /app/app/templates --tabwidth 2 --check
      echo
    fi
  fi
  echo
fi

. tna-nvm

echo "Running prettier..."
if [ -f "/app/.prettierignore" ]
then
  echo "Using app config"
  PRETTIER_IGNORE="/app/.prettierignore"
else
  echo "Using default config"
  PRETTIER_IGNORE="/home/app/.prettierignore"
fi
if [ "$FIX" = true ]
then
  npx --yes "prettier@$PRETTIER_VERSION" --ignore-path "$PRETTIER_IGNORE" --write --list-different /app
else
  npx --yes "prettier@$PRETTIER_VERSION" --ignore-path "$PRETTIER_IGNORE" --list-different /app
fi
echo

echo "Running stylelint..."
npm install -g --quiet "stylelint@$STYLELINT_VERSION" "stylelint-config-standard-scss@$STYLELINT_CONFIG_STANDARD_SCSS_VERSION" "stylelint-selector-bem-pattern@$STYLELINT_SELECTOR_BEM_PATTERN_VERSION" "stylelint-order@$STYLELINT_ORDER_VERSION"
if [ -f "/app/.stylelintrc" ]
then
  echo "Using app config (.stylelintrc)"
  STYLELINT_CONFIG="/app/.stylelintrc"
elif [ -f "/app/stylelint.config.js" ]
then
  echo "Using app config (stylelint.config.js)"
  STYLELINT_CONFIG="/app/stylelint.config.js"
elif [ -f "/app/.stylelintrc.js" ]
then
  echo "Using app config (.stylelintrc.js)"
  STYLELINT_CONFIG="/app/.stylelintrc.js"
elif [ -f "/app/stylelint.config.mjs" ]
then
  echo "Using app config (stylelint.config.mjs)"
  STYLELINT_CONFIG="/app/stylelint.config.mjs"
elif [ -f "/app/.stylelintrc.mjs" ]
then
  echo "Using app config (.stylelintrc.mjs)"
  STYLELINT_CONFIG="/app/.stylelintrc.mjs"
elif [ -f "/app/stylelint.config.cjs" ]
then
  echo "Using app config (stylelint.config.cjs)"
  STYLELINT_CONFIG="/app/stylelint.config.cjs"
elif [ -f "/app/.stylelintrc.cjs" ]
then
  echo "Using app config (.stylelintrc.cjs)"
  STYLELINT_CONFIG="/app/.stylelintrc.cjs"
elif [ -f "/app/.stylelintrc.json" ]
then
  echo "Using app config (.stylelintrc.json)"
  STYLELINT_CONFIG="/app/.stylelintrc.json"
elif [ -f "/app/.stylelintrc.yml" ]
then
  echo "Using app config (.stylelintrc.yml)"
  STYLELINT_CONFIG="/app/.stylelintrc.yml"
elif [ -f "/app/.stylelintrc.yaml" ]
then
  echo "Using app config (.stylelintrc.yaml)"
  STYLELINT_CONFIG="/app/.stylelintrc.yaml"
else
  echo "Using default config"
  STYLELINT_CONFIG="/home/app/.stylelintrc"
fi
if [ "$FIX" = true ]
then
  stylelint --config "$STYLELINT_CONFIG" --fix "/app/**/*.{css,scss}" --allow-empty-input
else
  stylelint --config "$STYLELINT_CONFIG" "/app/**/*.{css,scss}" --allow-empty-input
fi
echo

echo "Running eslint..."
if [ -f "/app/.eslintrc.js" ]
then
  echo "Using app config (.eslintrc.js)"
  ESLINT_CONFIG="/app/.eslintrc.js"
elif [ -f "/app/.eslintrc.mjs" ]
then
  echo "Using app config (.eslintrc.mjs)"
  ESLINT_CONFIG="/app/.eslintrc.mjs"
elif [ -f "/app/.eslintrc.cjs" ]
then
  echo "Using app config (.eslintrc.cjs)"
  ESLINT_CONFIG="/app/.eslintrc.cjs"
elif [ -f "/app/eslintrc.config.js" ]
then
  echo "Using app config (eslintrc.config.js)"
  ESLINT_CONFIG="/app/eslintrc.config.js"
elif [ -f "/app/eslintrc.config.mjs" ]
then
  echo "Using app config (eslintrc.config.mjs)"
  ESLINT_CONFIG="/app/eslintrc.config.mjs"
elif [ -f "/app/eslintrc.config.cjs" ]
then
  echo "Using app config (eslintrc.config.cjs)"
  ESLINT_CONFIG="/app/eslintrc.config.cjs"
else
  echo "Using default config"
  ESLINT_CONFIG="/home/app/.eslintrc.js"
fi
if [ "$FIX" = true ]
then
  npx --yes "eslint@$ESLINT_VERSION" --config "$ESLINT_CONFIG" --no-error-on-unmatched-pattern --fix "/app"
else
  npx --yes "eslint@$ESLINT_VERSION" --config "$ESLINT_CONFIG" --no-error-on-unmatched-pattern "/app"
fi
echo
