#!/bin/bash

set -e

echo "Running tna-build for base Python...";

if [ ! -f "/app/pyproject.toml" ]
then
  echo "pyproject.toml does not exist";
  exit 1
fi

if [ ! -f "/app/poetry.lock" ]
then
  echo "poetry.lock does not exist";
  exit 1
fi

if [ -n "$NPM_BUILD_COMMAND" ]
then
  if [ ! -f "/app/package.json" ]
  then
    echo "package.json does not exist";
    exit 1
  fi

  if [ ! -f "/app/package-lock.json" ]
  then
    echo "package-lock.json does not exist";
    exit 1
  fi

  tna-node "$NPM_BUILD_COMMAND"
fi

poetry add "gunicorn@$GUNICORN_VERSION"
poetry add "uvicorn@$UVICORN_VERSION"
poetry add "uvicorn-worker@$UVICORN_WORKER_VERSION"
poetry install --no-root --no-interaction
