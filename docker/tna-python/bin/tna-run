#!/bin/bash

if [ -z $1 ]
then
  echo "Usage: $0 my-app";
  echo -e "\tmy-app is the Python package you want to run"
  exit 1
fi

if [ $ENVIRONMENT == 'develop' ] && [ -f "/app/package.json" ] && [ -z $NPM_DEVELOP_COMMAND ]
then
  . "$HOME/.nvm/nvm.sh"
  NODE_VERSION=$(cat /app/.nvmrc)
  nvm use $NODE_VERSION
  npm install
  npm run $NPM_DEVELOP_COMMAND &
fi

DEFAULT_THREADS_AND_WORKERS=$(python -c "import multiprocessing; print(multiprocessing.cpu_count() * 2 + 1)")

if [ $ENVIRONMENT == 'production' ]
then
  [[ -z $LOG_LEVEL ]] && LOG_LEVEL=WARN
  [[ -z $WORKERS ]] && WORKERS=$DEFAULT_THREADS_AND_WORKERS
  [[ -z $THREADS ]] && THREADS=$DEFAULT_THREADS_AND_WORKERS
  poetry run gunicorn $1 --workers $WORKERS --threads $THREADS --log-level $LOG_LEVEL --access-logfile - --bind 0.0.0.0:8080
elif [ $ENVIRONMENT == 'develop' ]
then
  [[ -z $LOG_LEVEL ]] && LOG_LEVEL=DEBUG
  poetry run gunicorn $1 --workers 3 --threads 3 --log-level $LOG_LEVEL --reload --bind 0.0.0.0:8080
else
  [[ -z $LOG_LEVEL ]] && LOG_LEVEL=INFO
  [[ -z $WORKERS ]] && WORKERS=$DEFAULT_THREADS_AND_WORKERS
  [[ -z $THREADS ]] && THREADS=$DEFAULT_THREADS_AND_WORKERS
  poetry run gunicorn $1 --workers $WORKERS --threads $THREADS --log-level $LOG_LEVEL --access-logfile - --bind 0.0.0.0:8080
fi
