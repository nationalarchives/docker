#!/bin/bash

set -e

echo "Running tna-run for Python...";

# Set flag defaults
ASYNC=false

# Parse flags
while getopts ":a" option; do
  case "${option}" in
    a)
      ASYNC=true
      shift 1
      ;;
    ?)
      echo "Invalid option: -${OPTARG}"
      exit 1
      ;;
  esac
done

# Get the application
APPLICATION=$1

# Error if no application is passed
if [ -z "$APPLICATION" ]
then
  echo -e "Error: application not specified in tna-run\n";
  echo "PARAMETERS"
  echo "  application          the Python package you want to run"
  echo "                       Example: tna-run my_app:app";
  exit 1
fi

# Set up the default number of workers and threads
DEFAULT_WORKERS=$(python -c "import multiprocessing; print(multiprocessing.cpu_count() * 2 + 1)")
DEFAULT_THREADS=$((DEFAULT_WORKERS * 2))

# Set the worker class
[[ "$ASYNC" = true ]] && WORKER_CLASS=uvicorn_worker.UvicornWorker || WORKER_CLASS=sync

# Use the number of workers and threads (if provided) else use defaults
[[ -z $WORKERS ]] && WORKERS=$DEFAULT_WORKERS
[[ -z $THREADS ]] && THREADS=$DEFAULT_THREADS

# Set defaults for environment variables if they are not set
[[ -z $LOG_LEVEL ]] && LOG_LEVEL=warn
[[ -z $TIMEOUT ]] && TIMEOUT=30
[[ -z $KEEP_ALIVE ]] && KEEP_ALIVE=30

# Get the preference for allowing insecure connections to the container (defaults to false)
[[ -z $ALLOW_INSECURE ]] && ALLOW_INSECURE="false"
ALLOW_INSECURE=$(echo "$ALLOW_INSECURE" | tr '[:upper:]' '[:lower:]')

# If we are not allowing insecure connections, check for SSL certificates
if [ "$ALLOW_INSECURE" != "true" ]
then
  [[ -z $SSL_KEY_FILE ]] && SSL_KEY_FILE=/home/app/ssl/key.pem
  [[ -z $SSL_CERTIFICATE_FILE ]] && SSL_CERTIFICATE_FILE=/home/app/ssl/cert.pem

  # Check for SSL certificates
  if [ ! -f "$SSL_KEY_FILE" ]
  then
    echo "$SSL_KEY_FILE does not exist";
    exit 1
  fi
  if [ ! -f "$SSL_CERTIFICATE_FILE" ]
  then
    echo "$SSL_CERTIFICATE_FILE does not exist";
    exit 1
  fi
fi

# Start the server
echo "Starting server..."
poetry run gunicorn "$APPLICATION" --workers "$WORKERS" --threads "$THREADS" --log-level "$LOG_LEVEL" --timeout "$TIMEOUT" --keep-alive "$KEEP_ALIVE" --access-logfile - --bind "0.0.0.0:$PORT" --worker-class="$WORKER_CLASS" --keyfile="$SSL_KEY_FILE" --certfile="$SSL_CERTIFICATE_FILE"
