#!/bin/bash

set -e

echo "Running WSGI..."
echo

# Get the application
APPLICATION=$1

# Error if no application is passed
if [ -z "$APPLICATION" ]
then
  echo -e "Error: application not specified in tna-wsgi\n"
  echo "PARAMETERS"
  echo "  application          the Python package you want to run"
  echo "                       Example: tna-wsgi my_app:app"
  exit 1
fi

# Set up the default number of workers and threads
DEFAULT_WORKERS=$(python -c "import multiprocessing; print(multiprocessing.cpu_count() * 2 + 1)")
DEFAULT_THREADS=$((DEFAULT_WORKERS * 2))

# Use the number of workers and threads (if provided) else use defaults
[[ -z $WORKERS ]] && WORKERS=$DEFAULT_WORKERS
[[ -z $THREADS ]] && THREADS=$DEFAULT_THREADS

# Set defaults for environment variables if they are not set
[[ -z $LOG_LEVEL ]] && LOG_LEVEL=warn
[[ -z $TIMEOUT ]] && TIMEOUT=30
[[ -z $KEEP_ALIVE ]] && KEEP_ALIVE=30

# Get the protcol for the application
APPLICATION_PROTOCOL=$(echo "${APPLICATION_PROTOCOL:-https}" | tr '[:upper:]' '[:lower:]')

if [ "$APPLICATION_PROTOCOL" = "https" ]
then
  source tna-ssl-setup
  echo "Starting gunicorn (HTTPS)..."
  poetry run gunicorn "$APPLICATION" --workers "$WORKERS" --threads "$THREADS" --log-level "$LOG_LEVEL" --timeout "$TIMEOUT" --keep-alive "$KEEP_ALIVE" --access-logfile - --bind "0.0.0.0:$APPLICATION_PORT" --keyfile "$SSL_KEY_FILE" --certfile "$SSL_CERTIFICATE_FILE" --ca-certs "$SSL_CA_CERTIFICATES_FILE"
elif [ "$APPLICATION_PROTOCOL" = "http" ]
then
  echo "Starting gunicorn (HTTP)..."
  poetry run gunicorn "$APPLICATION" --workers "$WORKERS" --threads "$THREADS" --log-level "$LOG_LEVEL" --timeout "$TIMEOUT" --keep-alive "$KEEP_ALIVE" --access-logfile - --bind "0.0.0.0:$APPLICATION_PORT"
else
  echo -e "Error: invalid protocol specified in APPLICATION_PROTOCOL environment variable: '$APPLICATION_PROTOCOL'\n"
  echo "Allowed values are 'http' and 'https'"
  exit 1
fi
